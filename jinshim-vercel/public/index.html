<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì§„ì‹¬ì˜ ë¬´ê²Œ - ì—„ë²Œ íƒ„ì›ì„œ ì‘ì„±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>const _w=console.warn;console.warn=(...a)=>{if(a[0]?.includes?.('cdn.tailwindcss.com'))return;_w.apply(console,a)};</script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/docx@8.2.0/build/index.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dark': '#0f0f0f',
                        'gray': { 50: '#fafafa', 100: '#f4f4f5', 200: '#e4e4e7', 300: '#d4d4d8', 400: '#a1a1aa', 500: '#71717a', 600: '#52525b', 700: '#3f3f46', 800: '#27272a', 900: '#18181b' },
                    }
                }
            }
        }
    </script>
    <style>
        * { font-family: 'Noto Sans KR', -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }
        html, body { overscroll-behavior: none; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(100%); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        .fade-up { animation: fadeUp 0.6s ease-out forwards; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        .slide-up { animation: slideUp 0.3s ease-out forwards; }
        .animate-spin { animation: spin 1s linear infinite; }
        .delay-100 { animation-delay: 0.1s; opacity: 0; }
        .delay-200 { animation-delay: 0.2s; opacity: 0; }
        .delay-300 { animation-delay: 0.3s; opacity: 0; }
        input:focus, textarea:focus { outline: none; }
        ::-webkit-scrollbar { width: 3px; }
        ::-webkit-scrollbar-thumb { background: #ddd; border-radius: 3px; }
        .btn-press { transition: transform 0.1s; }
        .btn-press:active { transform: scale(0.97); }
    </style>
</head>
<body class="bg-white text-gray-900">
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;

        // === ICONS ===
        const Icons = {
            ArrowRight: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M5 12h14M12 5l7 7-7 7"/></svg>,
            ArrowLeft: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>,
            Check: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="2.5" viewBox="0 0 24 24"><path d="M20 6L9 17l-5-5"/></svg>,
            Copy: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15V5a2 2 0 012-2h10"/></svg>,
            Share: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><path d="M8.59 13.51l6.83 3.98M15.41 6.51l-6.82 3.98"/></svg>,
            Loader: () => <svg className="w-5 h-5 animate-spin" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M21 12a9 9 0 1 1-6.2-8.6"/></svg>,
            Scale: () => <svg className="w-12 h-12" fill="none" stroke="currentColor" strokeWidth="1.2" viewBox="0 0 24 24"><path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="M7 21h10M12 3v18M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2"/></svg>,
            Shield: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="m9 12 2 2 4-4"/></svg>,
            Kakao: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3C6.48 3 2 6.58 2 11c0 2.85 1.89 5.35 4.72 6.77-.15.53-.96 3.43-.99 3.64 0 0-.02.13.07.18.09.05.19.01.19.01.25-.03 2.91-1.89 3.36-2.21.86.13 1.75.2 2.65.2 5.52 0 10-3.58 10-8s-4.48-8-10-8z"/></svg>,
            Download: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
            Close: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12"/></svg>,
            Zap: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
        };

        // === DATA ===
        const damageOptions = [
            { id: 'insomnia', label: 'ë¶ˆë©´ì¦', desc: 'ì ì„ ì´ë£¨ì§€ ëª»í•¨' },
            { id: 'anxiety', label: 'ëŒ€ì¸ê¸°í”¼', desc: 'ì‚¬ëŒì„ í”¼í•˜ê²Œ ë¨' },
            { id: 'suicidal', label: 'ìì‚´ì¶©ë™', desc: 'ê·¹ë‹¨ì  ìƒê°' },
            { id: 'daily', label: 'ì¼ìƒíŒŒê´´', desc: 'ì •ìƒ ìƒí™œ ë¶ˆê°€' },
            { id: 'financial', label: 'ê²½ì œì  í”¼í•´', desc: 'ì§ì¥, ìˆ˜ì… ì†ì‹¤' },
            { id: 'ptsd', label: 'PTSD', desc: 'ì™¸ìƒ í›„ ìŠ¤íŠ¸ë ˆìŠ¤' },
            { id: 'depression', label: 'ìš°ìš¸ì¦', desc: 'ì§€ì†ì  ìš°ìš¸ê°' },
            { id: 'panic', label: 'ê³µí™©ì¥ì• ', desc: 'ê°‘ì‘ìŠ¤ëŸ° ê³µí¬' },
            { id: 'trust', label: 'ì‹ ë¢°ìƒì‹¤', desc: 'íƒ€ì¸ ë¶ˆì‹ ' },
            { id: 'career', label: 'ê²½ë ¥ë‹¨ì ˆ', desc: 'ì»¤ë¦¬ì–´ ì†ìƒ' },
            { id: 'family', label: 'ê°€ì¡±ê°ˆë“±', desc: 'ê°€ì • ë‚´ ë¬¸ì œ' },
            { id: 'physical', label: 'ì‹ ì²´ì¦ìƒ', desc: 'ëª¸ì˜ ì´ìƒ ë°˜ì‘' },
        ];

        const attitudeOptions = [
            { id: 'noApology', label: 'ì‚¬ê³¼ ì—†ìŒ', level: 'high' },
            { id: 'pressure', label: 'í•©ì˜ ì¢…ìš©', level: 'high' },
            { id: 'mockery', label: 'ë¹„ì›ƒìŒ/ì¡°ë¡±', level: 'critical' },
            { id: 'secondary', label: '2ì°¨ ê°€í•´', level: 'critical' },
            { id: 'copyPaste', label: 'ë°˜ì„±ë¬¸ ë³µë¶™', level: 'mid' },
            { id: 'blaming', label: 'í”¼í•´ì íƒ“', level: 'critical' },
            { id: 'denial', label: 'í˜ì˜ ë¶€ì¸', level: 'high' },
            { id: 'threat', label: 'í˜‘ë°•/íšŒìœ ', level: 'critical' },
            { id: 'spreading', label: 'ì†Œë¬¸ ìœ í¬', level: 'critical' },
            { id: 'stalking', label: 'ì ‘ê·¼ ì‹œë„', level: 'critical' },
        ];

        const relationships = ['ì—°ì¸/ì „ ì—°ì¸', 'ë°°ìš°ì/ì „ ë°°ìš°ì', 'ì§ì¥ ê´€ê³„', 'ì§€ì¸/ì¹œêµ¬', 'ê°€ì¡±/ì¹œì²™', 'ëª¨ë¥´ëŠ” ì‚¬ëŒ', 'ì˜¨ë¼ì¸ ì§€ì¸', 'ê¸°íƒ€'];

        const reviewPlans = [
            { id: 'basic', badge: 'ğŸ¥‰', name: 'ê¸°ë³¸ ê²€í† ', price: 33000, priceText: '33,000ì›', desc: 'í˜•ì‹/ì˜¤íƒˆì ê²€í† ', time: '24ì‹œê°„ ë‚´' },
            { id: 'standard', badge: 'ğŸ¥ˆ', name: 'ì •ë°€ ê²€í† ', price: 77000, priceText: '77,000ì›', desc: 'ë‚´ìš© ë³´ì™„ + ì½”ë©˜íŠ¸', time: '12ì‹œê°„ ë‚´', popular: true },
            { id: 'premium', badge: 'ğŸ¥‡', name: 'í”„ë¦¬ë¯¸ì—„', price: 165000, priceText: '165,000ì›', desc: 'ê²€í†  + ì „í™”ìƒë‹´ 15ë¶„', time: '6ì‹œê°„ ë‚´' },
            { id: 'vip', badge: 'ğŸ’', name: 'VIP', price: 330000, priceText: '330,000ì›', desc: 'ì™„ì „ ì¬ì‘ì„± + ìƒë‹´', time: 'ë‹¹ì¼' },
        ];

        const DAILY_LIMIT = 3;

        // === COMPONENTS ===

        // Landing Page
        const Landing = ({ onStart, usageInfo }) => (
            <div className="min-h-screen bg-dark flex flex-col items-center justify-center p-8 text-center relative overflow-hidden">
                <div className="absolute inset-0 bg-gradient-to-b from-gray-900 via-dark to-dark"></div>
                <div className="absolute top-1/4 left-1/2 -translate-x-1/2 w-96 h-96 bg-white/5 rounded-full blur-3xl"></div>
                
                <div className="relative z-10 max-w-sm mx-auto">
                    <div className="fade-up mb-8 flex justify-center">
                        <div className="text-white/80">
                            <Icons.Scale />
                        </div>
                    </div>
                    
                    <h1 className="fade-up delay-100 text-3xl font-bold text-white tracking-tight mb-2">
                        ì§„ì‹¬ì˜ ë¬´ê²Œ
                    </h1>
                    <p className="fade-up delay-100 text-white/40 text-sm mb-10">
                        ì—„ë²Œ íƒ„ì›ì„œ ì‘ì„± ë„ìš°ë¯¸
                    </p>
                    
                    <p className="fade-up delay-200 text-white/70 text-lg leading-relaxed mb-8 font-light">
                        ë­˜ ì¨ì•¼ í• ì§€ ë§‰ë§‰í–ˆë˜<br/>
                        ì—„ë²Œ íƒ„ì›ì„œ,<br/>
                        <span className="text-white font-normal">3ë¶„ì´ë©´ ì™„ì„±ë©ë‹ˆë‹¤</span>
                    </p>

                    {/* ì‚¬ìš©ëŸ‰ í‘œì‹œ */}
                    <div className="fade-up delay-200 mb-8">
                        <div className="inline-flex items-center gap-2 bg-white/10 backdrop-blur px-4 py-2 rounded-full">
                            <Icons.Zap />
                            <span className="text-white/80 text-sm">
                                ì˜¤ëŠ˜ ë¬´ë£Œ {usageInfo.remaining}íšŒ ë‚¨ìŒ
                            </span>
                        </div>
                    </div>
                    
                    <button 
                        onClick={onStart}
                        disabled={usageInfo.remaining <= 0}
                        className={`fade-up delay-300 w-full font-semibold py-4 rounded-2xl btn-press transition-colors ${
                            usageInfo.remaining > 0 
                                ? 'bg-white text-dark hover:bg-gray-100' 
                                : 'bg-gray-700 text-gray-400 cursor-not-allowed'
                        }`}
                    >
                        {usageInfo.remaining > 0 ? 'ì‘ì„± ì‹œì‘í•˜ê¸°' : 'ì˜¤ëŠ˜ ë¬´ë£Œ ì‚¬ìš© ì™„ë£Œ'}
                    </button>
                    
                    <p className="fade-up delay-300 text-white/30 text-xs mt-6">
                        ì‹ ë¶„ì¦ ë’·ìë¦¬ ë…¸ì¶œ ê±±ì • ì—†ì´ Â· ë¬´ë£Œ
                    </p>
                </div>
            </div>
        );

        // Progress Bar
        const Progress = ({ step, total }) => (
            <div className="flex gap-1.5 mb-8">
                {Array.from({ length: total }, (_, i) => (
                    <div 
                        key={i} 
                        className={`h-1 rounded-full flex-1 transition-all duration-300 ${
                            i < step ? 'bg-dark' : i === step ? 'bg-dark' : 'bg-gray-200'
                        }`}
                    />
                ))}
            </div>
        );

        // Chip Button
        const Chip = ({ selected, onClick, children, variant = 'default' }) => {
            const base = "px-4 py-3 rounded-xl text-sm font-medium transition-all btn-press border-2 text-left";
            const styles = {
                default: selected 
                    ? "bg-dark text-white border-dark" 
                    : "bg-white text-gray-700 border-gray-200 hover:border-gray-300",
                danger: selected 
                    ? "bg-red-600 text-white border-red-600" 
                    : "bg-white text-gray-700 border-gray-200 hover:border-red-200",
            };
            return (
                <button onClick={onClick} className={`${base} ${styles[variant]}`}>
                    {children}
                </button>
            );
        };

        // Main App
        function App() {
            const [page, setPage] = useState('landing');
            const [step, setStep] = useState(0);
            const [form, setForm] = useState({
                caseNumber: '',
                defendant: '',
                relationship: '',
                damages: [],
                attitudes: [],
                message: '',
                isVictim: null,
            });
            const [result, setResult] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [showReviewModal, setShowReviewModal] = useState(false);
            const [selectedPlan, setSelectedPlan] = useState(null);
            const [usageInfo, setUsageInfo] = useState({ used: 0, remaining: DAILY_LIMIT, limit: DAILY_LIMIT });

            const totalSteps = 5; // API í‚¤ ë‹¨ê³„ ì œê±°ë¡œ 5ë‹¨ê³„

            // ë¡œì»¬ ì‚¬ìš©ëŸ‰ ì²´í¬
            useEffect(() => {
                const today = new Date().toISOString().split('T')[0];
                const storageKey = `petition_usage_${today}`;
                const stored = localStorage.getItem(storageKey);
                const used = stored ? parseInt(stored, 10) : 0;
                setUsageInfo({
                    used,
                    remaining: Math.max(0, DAILY_LIMIT - used),
                    limit: DAILY_LIMIT
                });

                // ì˜¤ë˜ëœ í‚¤ ì •ë¦¬
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('petition_usage_') && !key.includes(today)) {
                        localStorage.removeItem(key);
                    }
                });
            }, []);

            const incrementLocalUsage = () => {
                const today = new Date().toISOString().split('T')[0];
                const storageKey = `petition_usage_${today}`;
                const stored = localStorage.getItem(storageKey);
                const used = (stored ? parseInt(stored, 10) : 0) + 1;
                localStorage.setItem(storageKey, used.toString());
                setUsageInfo({
                    used,
                    remaining: Math.max(0, DAILY_LIMIT - used),
                    limit: DAILY_LIMIT
                });
            };

            const toggleArray = (key, value) => {
                setForm(prev => ({
                    ...prev,
                    [key]: prev[key].includes(value) 
                        ? prev[key].filter(v => v !== value)
                        : [...prev[key], value]
                }));
            };

            const canProceed = () => {
                switch(step) {
                    case 0: return form.isVictim !== null;
                    case 1: return form.caseNumber && form.defendant && form.relationship;
                    case 2: return form.damages.length > 0;
                    case 3: return true;
                    case 4: return true;
                    default: return false;
                }
            };

            const generate = async () => {
                if (usageInfo.remaining <= 0) {
                    setShowReviewModal(true);
                    return;
                }

                setLoading(true);
                setError('');

                const damageLabels = form.damages.map(id => damageOptions.find(o => o.id === id)?.label).filter(Boolean);
                const attitudeLabels = form.attitudes.map(id => attitudeOptions.find(o => o.id === id)?.label).filter(Boolean);

                try {
                    const res = await fetch('/api/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            caseNumber: form.caseNumber,
                            defendant: form.defendant,
                            relationship: form.relationship,
                            damages: damageLabels,
                            attitudes: attitudeLabels,
                            message: form.message,
                            isVictim: form.isVictim
                        })
                    });

                    const data = await res.json();

                    if (!res.ok) {
                        if (data.error === 'RATE_LIMIT_EXCEEDED') {
                            setUsageInfo({ used: DAILY_LIMIT, remaining: 0, limit: DAILY_LIMIT });
                            setShowReviewModal(true);
                            return;
                        }
                        throw new Error(data.error || data.message || 'API ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
                    }

                    setResult(data.content);
                    incrementLocalUsage();
                    if (data.usage) {
                        setUsageInfo(data.usage);
                    }
                    setPage('result');

                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const saveAsDocx = async () => {
                try {
                    const { Document, Packer, Paragraph, TextRun, AlignmentType, LineRuleType } = docx;
                    
                    const lines = result.split('\n');
                    const paragraphs = [];
                    
                    lines.forEach((line) => {
                        const trimmed = line.trim();
                        
                        if (trimmed === 'íƒ„ì›ì„œ' || trimmed === 'íƒ„ ì› ì„œ') {
                            paragraphs.push(new Paragraph({
                                children: [new TextRun({
                                    text: trimmed,
                                    font: 'íœ´ë¨¼ëª…ì¡°',
                                    size: 40,
                                    bold: true,
                                })],
                                alignment: AlignmentType.CENTER,
                                spacing: { after: 400, line: 375, lineRule: LineRuleType.AUTO },
                            }));
                        } else if (trimmed === '') {
                            paragraphs.push(new Paragraph({
                                children: [],
                                spacing: { after: 200 },
                            }));
                        } else {
                            paragraphs.push(new Paragraph({
                                children: [new TextRun({
                                    text: trimmed,
                                    font: 'íœ´ë¨¼ëª…ì¡°',
                                    size: 24,
                                })],
                                spacing: { after: 120, line: 375, lineRule: LineRuleType.AUTO },
                            }));
                        }
                    });
                    
                    const doc = new Document({
                        sections: [{
                            properties: {
                                page: {
                                    margin: { top: 1440, right: 1440, bottom: 1440, left: 1440 },
                                },
                            },
                            children: paragraphs,
                        }],
                    });
                    
                    const blob = await Packer.toBlob(doc);
                    const now = new Date();
                    const dateStr = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}`;
                    saveAs(blob, `ì—„ë²Œíƒ„ì›ì„œ_${form.defendant || 'í”¼ê³ ì¸'}_${dateStr}.docx`);
                    
                } catch (err) {
                    console.error('DOCX ìƒì„± ì˜¤ë¥˜:', err);
                    alert('íŒŒì¼ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
                }
            };

            const shareKakao = () => {
                const url = window.location.href;
                if (navigator.share) {
                    navigator.share({
                        title: 'ì—„ë²Œ íƒ„ì›ì„œ - ì§„ì‹¬ì˜ ë¬´ê²Œ',
                        text: 'íƒ„ì›ì„œ ì‘ì„±ì„ ë¶€íƒë“œë¦½ë‹ˆë‹¤.',
                        url: url
                    });
                } else {
                    window.open(`https://story.kakao.com/share?url=${encodeURIComponent(url)}`, '_blank');
                }
            };

            // Render steps
            const renderStep = () => {
                switch(step) {
                    case 0:
                        return (
                            <div className="fade-in">
                                <h2 className="text-xl font-semibold mb-2">ì‘ì„±ì í™•ì¸</h2>
                                <p className="text-gray-500 text-sm mb-8">íƒ„ì›ì„œë¥¼ ëˆ„ê°€ ì‘ì„±í•˜ì‹œë‚˜ìš”?</p>
                                
                                <div className="space-y-3">
                                    <button 
                                        onClick={() => setForm({...form, isVictim: true})}
                                        className={`w-full p-5 rounded-2xl border-2 text-left transition-all btn-press ${
                                            form.isVictim === true 
                                                ? 'border-dark bg-dark text-white' 
                                                : 'border-gray-200 hover:border-gray-300'
                                        }`}
                                    >
                                        <div className="font-semibold mb-1">í”¼í•´ì ë³¸ì¸</div>
                                        <div className={`text-sm ${form.isVictim === true ? 'text-white/70' : 'text-gray-500'}`}>
                                            ì§ì ‘ íƒ„ì›ì„œë¥¼ ì‘ì„±í•©ë‹ˆë‹¤
                                        </div>
                                    </button>
                                    
                                    <button 
                                        onClick={() => setForm({...form, isVictim: false})}
                                        className={`w-full p-5 rounded-2xl border-2 text-left transition-all btn-press ${
                                            form.isVictim === false 
                                                ? 'border-dark bg-dark text-white' 
                                                : 'border-gray-200 hover:border-gray-300'
                                        }`}
                                    >
                                        <div className="font-semibold mb-1">í”¼í•´ì ì§€ì¸</div>
                                        <div className={`text-sm ${form.isVictim === false ? 'text-white/70' : 'text-gray-500'}`}>
                                            í”¼í•´ìë¥¼ ëŒ€ì‹ í•´ íƒ„ì›ì„œë¥¼ ì‘ì„±í•©ë‹ˆë‹¤
                                        </div>
                                    </button>
                                </div>
                            </div>
                        );

                    case 1:
                        return (
                            <div className="fade-in">
                                <h2 className="text-xl font-semibold mb-2">ì‚¬ê±´ ì •ë³´</h2>
                                <p className="text-gray-500 text-sm mb-8">ê¸°ë³¸ì ì¸ ì‚¬ê±´ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
                                
                                <div className="space-y-4">
                                    <div>
                                        <label className="text-sm font-medium text-gray-700 mb-2 block">ì‚¬ê±´ë²ˆí˜¸</label>
                                        <input
                                            type="text"
                                            value={form.caseNumber}
                                            onChange={e => setForm({...form, caseNumber: e.target.value})}
                                            placeholder="ì˜ˆ: 2024ê³ ë‹¨1234"
                                            className="w-full px-4 py-3.5 bg-gray-100 rounded-xl placeholder:text-gray-400 focus:bg-gray-50 focus:ring-2 focus:ring-dark/10"
                                        />
                                    </div>
                                    
                                    <div>
                                        <label className="text-sm font-medium text-gray-700 mb-2 block">í”¼ê³ ì¸(ê°€í•´ì)</label>
                                        <input
                                            type="text"
                                            value={form.defendant}
                                            onChange={e => setForm({...form, defendant: e.target.value})}
                                            placeholder="ì´ë¦„"
                                            className="w-full px-4 py-3.5 bg-gray-100 rounded-xl placeholder:text-gray-400 focus:bg-gray-50 focus:ring-2 focus:ring-dark/10"
                                        />
                                    </div>
                                    
                                    <div>
                                        <label className="text-sm font-medium text-gray-700 mb-2 block">í”¼í•´ìì™€ì˜ ê´€ê³„</label>
                                        <div className="grid grid-cols-2 gap-2">
                                            {relationships.map(rel => (
                                                <Chip 
                                                    key={rel}
                                                    selected={form.relationship === rel}
                                                    onClick={() => setForm({...form, relationship: rel})}
                                                >
                                                    {rel}
                                                </Chip>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        );

                    case 2:
                        return (
                            <div className="fade-in">
                                <h2 className="text-xl font-semibold mb-2">í”¼í•´ ì¦ìƒ</h2>
                                <p className="text-gray-500 text-sm mb-8">í•´ë‹¹í•˜ëŠ” í”¼í•´ë¥¼ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”</p>
                                
                                <div className="grid grid-cols-2 gap-2">
                                    {damageOptions.map(opt => (
                                        <Chip
                                            key={opt.id}
                                            selected={form.damages.includes(opt.id)}
                                            onClick={() => toggleArray('damages', opt.id)}
                                        >
                                            <div className="font-medium">{opt.label}</div>
                                            <div className={`text-xs mt-0.5 ${form.damages.includes(opt.id) ? 'text-white/60' : 'text-gray-400'}`}>
                                                {opt.desc}
                                            </div>
                                        </Chip>
                                    ))}
                                </div>
                            </div>
                        );

                    case 3:
                        return (
                            <div className="fade-in">
                                <h2 className="text-xl font-semibold mb-2">ê°€í•´ì íƒœë„</h2>
                                <p className="text-gray-500 text-sm mb-8">ê°€í•´ìì˜ íƒœë„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš” (ì„ íƒì‚¬í•­)</p>
                                
                                <div className="grid grid-cols-2 gap-2">
                                    {attitudeOptions.map(opt => (
                                        <Chip
                                            key={opt.id}
                                            selected={form.attitudes.includes(opt.id)}
                                            onClick={() => toggleArray('attitudes', opt.id)}
                                            variant="danger"
                                        >
                                            {opt.label}
                                        </Chip>
                                    ))}
                                </div>
                            </div>
                        );

                    case 4:
                        return (
                            <div className="fade-in">
                                <h2 className="text-xl font-semibold mb-2">ì „í•˜ê³  ì‹¶ì€ ë§</h2>
                                <p className="text-gray-500 text-sm mb-8">íŒì‚¬ë‹˜ê»˜ ì „í•˜ê³  ì‹¶ì€ ë§ì´ ìˆë‹¤ë©´ ì ì–´ì£¼ì„¸ìš”</p>
                                
                                <textarea
                                    value={form.message}
                                    onChange={e => setForm({...form, message: e.target.value})}
                                    placeholder="ì„ íƒì‚¬í•­ì…ë‹ˆë‹¤"
                                    rows={5}
                                    className="w-full px-4 py-4 bg-gray-100 rounded-xl placeholder:text-gray-400 focus:bg-gray-50 focus:ring-2 focus:ring-dark/10 resize-none"
                                />
                                
                                {error && (
                                    <div className="mt-4 p-4 bg-red-50 text-red-600 rounded-xl text-sm">
                                        {error}
                                    </div>
                                )}

                                {/* ë‚¨ì€ íšŸìˆ˜ í‘œì‹œ */}
                                <div className="mt-4 p-3 bg-gray-50 rounded-xl flex items-center justify-between">
                                    <span className="text-sm text-gray-500">ì˜¤ëŠ˜ ë‚¨ì€ ë¬´ë£Œ íšŸìˆ˜</span>
                                    <span className="font-semibold text-dark">{usageInfo.remaining}íšŒ</span>
                                </div>
                            </div>
                        );
                }
            };

            // Review Modal
            const ReviewModal = () => (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center p-0 sm:p-4">
                    <div className="bg-white w-full sm:max-w-md sm:rounded-3xl rounded-t-3xl max-h-[90vh] overflow-hidden fade-in">
                        <div className="sticky top-0 bg-white border-b border-gray-100 px-5 py-4 flex items-center justify-between">
                            <div>
                                <h3 className="text-lg font-bold text-gray-900">
                                    {usageInfo.remaining <= 0 ? 'ë¬´ë£Œ ì‚¬ìš© ì™„ë£Œ' : 'ì „ë¬¸ê°€ ê²€í†  ì‹ ì²­'}
                                </h3>
                                <p className="text-sm text-gray-500">
                                    {usageInfo.remaining <= 0 
                                        ? 'ì „ë¬¸ê°€ ê²€í† ë¡œ ë” ì™„ë²½í•œ íƒ„ì›ì„œë¥¼ ë°›ì•„ë³´ì„¸ìš”' 
                                        : 'ê²€í†  ë“±ê¸‰ì„ ì„ íƒí•´ì£¼ì„¸ìš”'}
                                </p>
                            </div>
                            <button 
                                onClick={() => { setShowReviewModal(false); setSelectedPlan(null); }}
                                className="p-2 -mr-2 text-gray-400 hover:text-gray-600"
                            >
                                <Icons.Close />
                            </button>
                        </div>
                        
                        <div className="p-5 space-y-3 overflow-y-auto max-h-[60vh]">
                            {usageInfo.remaining <= 0 && (
                                <div className="p-4 bg-amber-50 border border-amber-200 rounded-xl mb-4">
                                    <p className="text-sm text-amber-800">
                                        ğŸ’¡ ì˜¤ëŠ˜ ë¬´ë£Œ ì‚¬ìš© íšŸìˆ˜ë¥¼ ëª¨ë‘ ì‚¬ìš©í•˜ì…¨ìŠµë‹ˆë‹¤.<br/>
                                        ì „ë¬¸ê°€ ê²€í† ë¥¼ í†µí•´ ë” ì™„ì„±ë„ ë†’ì€ íƒ„ì›ì„œë¥¼ ë°›ì•„ë³´ì„¸ìš”.
                                    </p>
                                </div>
                            )}

                            {reviewPlans.map(plan => (
                                <button
                                    key={plan.id}
                                    onClick={() => setSelectedPlan(plan.id)}
                                    className={`w-full p-4 rounded-2xl border-2 text-left transition-all btn-press relative ${
                                        selectedPlan === plan.id
                                            ? 'border-dark bg-dark text-white'
                                            : 'border-gray-200 hover:border-gray-300 bg-white'
                                    }`}
                                >
                                    {plan.popular && (
                                        <span className={`absolute -top-2 right-4 text-xs font-bold px-2 py-0.5 rounded-full ${
                                            selectedPlan === plan.id ? 'bg-white text-dark' : 'bg-dark text-white'
                                        }`}>
                                            ì¸ê¸°
                                        </span>
                                    )}
                                    <div className="flex items-start justify-between">
                                        <div>
                                            <div className="flex items-center gap-2 mb-1">
                                                <span className="text-lg">{plan.badge}</span>
                                                <span className="font-semibold">{plan.name}</span>
                                            </div>
                                            <p className={`text-sm ${selectedPlan === plan.id ? 'text-white/70' : 'text-gray-500'}`}>
                                                {plan.desc}
                                            </p>
                                            <p className={`text-xs mt-1 ${selectedPlan === plan.id ? 'text-white/50' : 'text-gray-400'}`}>
                                                â± {plan.time}
                                            </p>
                                        </div>
                                        <div className={`text-right ${selectedPlan === plan.id ? 'text-white' : 'text-gray-900'}`}>
                                            <span className="text-lg font-bold">{plan.priceText}</span>
                                        </div>
                                    </div>
                                </button>
                            ))}
                        </div>
                        
                        <div className="sticky bottom-0 bg-white border-t border-gray-100 p-5 space-y-3">
                            <a
                                href={selectedPlan ? `http://pf.kakao.com/_YxgWxcn/chat?text=${encodeURIComponent(`[íƒ„ì›ì„œ ê²€í†  ì‹ ì²­]\n\nğŸ“‹ ì„ íƒ ìƒí’ˆ: ${reviewPlans.find(p => p.id === selectedPlan)?.name} (${reviewPlans.find(p => p.id === selectedPlan)?.priceText})\nğŸ“Œ ì‚¬ê±´ë²ˆí˜¸: ${form.caseNumber}\nğŸ“Œ í”¼ê³ ì¸: ${form.defendant}\n\níƒ„ì›ì„œ íŒŒì¼ì€ ë³„ë„ë¡œ ì „ì†¡ë“œë¦¬ê² ìŠµë‹ˆë‹¤.`)}` : '#'}
                                target="_blank"
                                onClick={(e) => { if (!selectedPlan) { e.preventDefault(); alert('ê²€í†  ë“±ê¸‰ì„ ì„ íƒí•´ì£¼ì„¸ìš”'); } }}
                                className={`w-full py-4 rounded-2xl font-semibold flex items-center justify-center gap-2 transition-all ${
                                    selectedPlan 
                                        ? 'bg-[#FEE500] text-[#191919] btn-press hover:bg-[#FDD800]' 
                                        : 'bg-gray-200 text-gray-400 cursor-not-allowed'
                                }`}
                            >
                                <Icons.Kakao /> ì¹´ì¹´ì˜¤í†¡ìœ¼ë¡œ ì‹ ì²­í•˜ê¸°
                            </a>
                            <p className="text-center text-xs text-gray-400">
                                ì‹ ì²­ í›„ ê²°ì œ ì•ˆë‚´ë¥¼ ë°›ìœ¼ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤
                            </p>
                        </div>
                    </div>
                </div>
            );

            // === PAGES ===

            if (page === 'landing') {
                return <Landing onStart={() => setPage('form')} usageInfo={usageInfo} />;
            }

            if (page === 'result') {
                return (
                    <div className="min-h-screen bg-white">
                        <div className="max-w-lg mx-auto p-5">
                            <div className="flex items-center justify-between mb-6">
                                <h1 className="text-lg font-semibold">íƒ„ì›ì„œ ì™„ì„±</h1>
                                <button 
                                    onClick={() => { setPage('form'); setStep(0); setResult(''); }}
                                    className="text-gray-500 text-sm"
                                >
                                    ë‹¤ì‹œ ì‘ì„±
                                </button>
                            </div>

                            <div className="bg-gray-50 rounded-2xl p-5 mb-6">
                                <textarea
                                    value={result}
                                    onChange={e => setResult(e.target.value)}
                                    rows={16}
                                    className="w-full bg-transparent text-sm leading-relaxed resize-none focus:outline-none"
                                />
                            </div>

                            <div className="space-y-3">
                                <button
                                    onClick={saveAsDocx}
                                    className="w-full py-4 rounded-2xl font-semibold bg-dark text-white flex items-center justify-center gap-2 btn-press hover:bg-gray-800"
                                >
                                    <Icons.Download /> í•œê¸€íŒŒì¼ë¡œ ì €ì¥ (.docx)
                                </button>

                                <button
                                    onClick={shareKakao}
                                    className="w-full py-4 rounded-2xl font-semibold bg-[#FEE500] text-[#191919] flex items-center justify-center gap-2 btn-press hover:bg-[#FDD800]"
                                >
                                    <Icons.Kakao /> ì¹´ì¹´ì˜¤í†¡ìœ¼ë¡œ ê³µìœ 
                                </button>

                                <div className="pt-4 border-t border-gray-100 mt-6">
                                    <p className="text-center text-gray-500 text-sm mb-3">
                                        ì „ë¬¸ê°€ ê²€í† ë¡œ ë” ì™„ë²½í•˜ê²Œ
                                    </p>
                                    <button
                                        onClick={() => setShowReviewModal(true)}
                                        className="w-full py-4 rounded-2xl font-semibold border-2 border-dark text-dark flex items-center justify-center gap-2 btn-press hover:bg-gray-50"
                                    >
                                        <Icons.Shield /> ë³€í˜¸ì‚¬ ê²€í†  ë°›ê¸°
                                    </button>
                                </div>
                            </div>

                            {showReviewModal && <ReviewModal />}

                            <footer className="mt-12 pt-6 border-t border-gray-100 text-center">
                                <p className="text-xs text-gray-400">
                                    ë²•ë¥  ìë¬¸ í˜‘ë ¥: ë²•ë¥ ì‚¬ë¬´ì†Œ ë¡œì•¤ì´
                                </p>
                                <p className="text-xs text-gray-300 mt-1">
                                    ë³¸ ì„œë¹„ìŠ¤ëŠ” ì°¸ê³ ìš©ì´ë©° ë²•ì  íš¨ë ¥ì„ ë³´ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤
                                </p>
                            </footer>
                        </div>
                    </div>
                );
            }

            // Form page
            return (
                <div className="min-h-screen bg-white">
                    <div className="max-w-lg mx-auto p-5">
                        <div className="flex items-center justify-between mb-6">
                            <button 
                                onClick={() => step > 0 ? setStep(step - 1) : setPage('landing')}
                                className="p-2 -ml-2 text-gray-600"
                            >
                                <Icons.ArrowLeft />
                            </button>
                            <span className="text-sm text-gray-400">{step + 1} / {totalSteps}</span>
                            <div className="w-9"></div>
                        </div>

                        <Progress step={step} total={totalSteps} />

                        {renderStep()}

                        <div className="mt-8">
                            {step < totalSteps - 1 ? (
                                <button
                                    onClick={() => setStep(step + 1)}
                                    disabled={!canProceed()}
                                    className="w-full py-4 rounded-2xl font-semibold bg-dark text-white disabled:bg-gray-200 disabled:text-gray-400 flex items-center justify-center gap-2 btn-press transition-colors"
                                >
                                    ë‹¤ìŒ <Icons.ArrowRight />
                                </button>
                            ) : (
                                <button
                                    onClick={generate}
                                    disabled={loading}
                                    className="w-full py-4 rounded-2xl font-semibold bg-dark text-white disabled:bg-gray-400 flex items-center justify-center gap-2 btn-press"
                                >
                                    {loading ? <><Icons.Loader /> ì‘ì„± ì¤‘...</> : 'íƒ„ì›ì„œ ìƒì„±í•˜ê¸°'}
                                </button>
                            )}
                        </div>

                        {showReviewModal && <ReviewModal />}

                        <footer className="mt-12 pt-6 border-t border-gray-100 text-center">
                            <p className="text-xs text-gray-300">
                                ë²•ë¥  ìë¬¸ í˜‘ë ¥: ë²•ë¥ ì‚¬ë¬´ì†Œ ë¡œì•¤ì´
                            </p>
                        </footer>
                    </div>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
